<!DOCTYPE html>
<!-- Power Plant Animation - SmartGrid (Dashboard Style) - v2 -->
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animazione Centrale Elettrica - SmartGrid</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-dark: #e8e6e1;
            --bg-card: #d0cec9;
            --bg-elevated: #f5f3ef;
            --bg-diagram: #dddbd6;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-tertiary: #6a6a6a;
            --accent-fire: #b05a2a;
            --accent-fire-light: #d07040;
            --accent-steam: #5a7a8a;
            --accent-steam-light: #7a9aaa;
            --accent-electric: #4a4a68;
            --accent-electric-light: #5a5a78;
            --accent-water: #3a5a8a;
            --accent-water-light: #5a7aaa;
            --accent-green: #4a6a5a;
            --accent-green-light: #5a8a6a;
            --accent-yellow: #7a6a2a;
            --accent-yellow-light: #9a8a3a;
            --accent-red: #8a4a4a;
            --accent-purple: #5a4a6a;
            --accent-bar: #4a4a68;
            --border: rgba(0,0,0,0.08);
            --border-active: rgba(0,0,0,0.2);
        }

        body {
            font-family: 'Archivo', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            font-weight: 400;
        }

        #root { min-height: 100vh; }

        /* Animations */
        @keyframes flame {
            0%, 100% { transform: scaleY(1) scaleX(1); opacity: 0.9; }
            25% { transform: scaleY(1.2) scaleX(0.88); opacity: 1; }
            50% { transform: scaleY(0.85) scaleX(1.12); opacity: 0.8; }
            75% { transform: scaleY(1.15) scaleX(0.92); opacity: 0.95; }
        }

        @keyframes flame-core {
            0%, 100% { transform: scaleY(1); opacity: 0.8; }
            50% { transform: scaleY(1.3); opacity: 1; }
        }

        @keyframes steam-rise {
            0% { transform: translateY(0) scale(1); opacity: 0.6; }
            40% { opacity: 0.4; }
            100% { transform: translateY(-45px) scale(2); opacity: 0; }
        }

        @keyframes turbine-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes turbine-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes electric-pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        @keyframes flow-dash {
            to { stroke-dashoffset: -24; }
        }

        @keyframes flow-dash-reverse {
            to { stroke-dashoffset: 24; }
        }

        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes cooling-tower-steam {
            0% { transform: translateY(0) scale(0.4); opacity: 0.5; }
            100% { transform: translateY(-60px) scale(3); opacity: 0; }
        }

        @keyframes spark {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0.5); }
        }

        @keyframes rotor-coil-pulse {
            0%, 100% { stroke: var(--accent-electric); opacity: 0.4; }
            50% { stroke: var(--accent-electric-light); opacity: 1; }
        }

        @keyframes heatShimmer {
            0%, 100% { opacity: 0.1; transform: translateX(0); }
            50% { opacity: 0.25; transform: translateX(2px); }
        }

        @keyframes progressPulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        @keyframes connectionPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .turbine-blade-group {
            transform-origin: center;
            transform-box: fill-box;
        }

        .turbine-spinning .turbine-blade-group {
            animation: turbine-spin 0.7s linear infinite;
        }

        .turbine-idle .turbine-blade-group {
            animation: turbine-slow 8s linear infinite;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // ─── Data ────────────────────────────────────────
        const PHASES = [
            {
                id: 'fuel',
                title: '1. Combustione',
                subtitle: 'Fonte di Energia Primaria',
                description: 'Il combustibile (carbone, gas naturale, uranio) viene bruciato o sottoposto a fissione nucleare nella fornace della caldaia. L\'energia chimica o nucleare si trasforma in energia termica, producendo temperature fino a 1.500\u00b0C. In una centrale nucleare, la fissione dell\'uranio-235 avviene nel nocciolo del reattore.',
                details: [
                    { label: 'Temperatura', value: '1.500\u00b0C' },
                    { label: 'Combustibile', value: 'Gas / Carbone / U-235' },
                    { label: 'Conversione', value: 'Chimica \u2192 Termica' },
                ],
                color: 'var(--accent-fire)',
            },
            {
                id: 'boiler',
                title: '2. Caldaia',
                subtitle: 'Generazione Vapore ad Alta Pressione',
                description: 'Il calore generato riscalda l\'acqua nei tubi della caldaia attraverso scambiatori di calore. L\'acqua si trasforma in vapore surriscaldato ad alta pressione (fino a 250 bar e 600\u00b0C), pronto per azionare la turbina. Il processo sfrutta il ciclo termodinamico di Rankine.',
                details: [
                    { label: 'Pressione', value: '250 bar' },
                    { label: 'Temperatura', value: '600\u00b0C' },
                    { label: 'Stato', value: 'Vapore Surriscaldato' },
                ],
                color: 'var(--accent-steam)',
            },
            {
                id: 'turbine',
                title: '3. Turbina a Vapore',
                subtitle: 'Conversione in Energia Meccanica',
                description: 'Il vapore ad alta pressione colpisce le pale della turbina, facendola ruotare a 3.000 giri/min. La turbina \u00e8 composta da pi\u00f9 stadi (alta, media e bassa pressione) per estrarre il massimo dell\'energia termica. L\'espansione progressiva del vapore genera coppia meccanica.',
                details: [
                    { label: 'Velocit\u00e0', value: '3.000 RPM' },
                    { label: 'Stadi', value: 'AP / MP / BP' },
                    { label: 'Conversione', value: 'Termica \u2192 Meccanica' },
                ],
                color: 'var(--accent-yellow)',
            },
            {
                id: 'generator',
                title: '4. Alternatore',
                subtitle: 'Generazione Corrente Elettrica',
                description: 'La turbina \u00e8 collegata meccanicamente al generatore (alternatore sincrono). La rotazione del rotore nel campo magnetico genera corrente alternata trifase a 50 Hz secondo la legge di Faraday. La potenza generata pu\u00f2 raggiungere 1.200 MW per singola unit\u00e0.',
                details: [
                    { label: 'Frequenza', value: '50 Hz' },
                    { label: 'Tensione', value: '15-25 kV' },
                    { label: 'Conversione', value: 'Meccanica \u2192 Elettrica' },
                ],
                color: 'var(--accent-electric)',
            },
            {
                id: 'transformer',
                title: '5. Trasformatore',
                subtitle: 'Elevazione di Tensione',
                description: 'Il trasformatore elevatore aumenta la tensione da ~20 kV a 132-380 kV per il trasporto efficiente su lunghe distanze. Secondo la legge di Joule, l\'alta tensione riduce la corrente e quindi le perdite ohmiche (P = I\u00b2R) nelle linee di trasmissione.',
                details: [
                    { label: 'Ingresso', value: '20 kV' },
                    { label: 'Uscita', value: '380 kV' },
                    { label: 'Efficienza', value: '99.5%' },
                ],
                color: 'var(--accent-green)',
            },
            {
                id: 'cooling',
                title: '6. Condensatore',
                subtitle: 'Ciclo di Raffreddamento',
                description: 'Il vapore esausto viene condensato nuovamente in acqua nel condensatore, utilizzando acqua di raffreddamento da fiumi o torri evaporative. L\'acqua condensata torna in caldaia attraverso pompe di alimento, completando il ciclo termodinamico di Rankine chiuso.',
                details: [
                    { label: 'Temperatura', value: '30-40\u00b0C' },
                    { label: 'Pressione', value: '0.05 bar' },
                    { label: 'Ciclo', value: 'Rankine Chiuso' },
                ],
                color: 'var(--accent-water)',
            },
        ];

        // ─── SVG Components ─────────────────────────────

        function Flame({ x, y, active, scale = 1 }) {
            if (!active) return null;
            return (
                <g transform={`translate(${x},${y}) scale(${scale})`}>
                    {[-15, -5, 5, 15].map((ox, i) => (
                        <ellipse key={`o-${i}`} cx={ox} cy={0} rx={5} ry={16 + Math.sin(i) * 3}
                            fill={i % 2 === 0 ? '#c05020' : '#d08030'}
                            opacity={0.8}
                            style={{ animation: `flame ${0.35 + i * 0.12}s ease-in-out infinite`, transformOrigin: `${ox}px 10px`, animationDelay: `${i * 0.08}s` }} />
                    ))}
                    {[-8, 0, 8].map((ox, i) => (
                        <ellipse key={`i-${i}`} cx={ox} cy={3} rx={3.5} ry={10}
                            fill="#d0a030"
                            opacity={0.7}
                            style={{ animation: `flame-core ${0.3 + i * 0.1}s ease-in-out infinite`, transformOrigin: `${ox}px 8px`, animationDelay: `${i * 0.12}s` }} />
                    ))}
                    <ellipse cx={0} cy={6} rx={3} ry={6} fill="#e0c060" opacity={0.5}
                        style={{ animation: 'flame-core 0.25s ease-in-out infinite' }} />
                </g>
            );
        }

        function SteamParticles({ x, y, active, count = 7 }) {
            if (!active) return null;
            return (
                <g transform={`translate(${x},${y})`}>
                    {Array.from({ length: count }).map((_, i) => (
                        <circle key={i} cx={(i - count/2) * 7 + Math.sin(i * 1.5) * 3} cy={0}
                            r={2.5 + (i % 3)} fill="var(--accent-steam-light)" opacity={0.5}
                            style={{ animation: `steam-rise ${1.5 + i * 0.25}s ease-out infinite`, animationDelay: `${i * 0.2}s` }} />
                    ))}
                </g>
            );
        }

        function TurbineIcon({ x, y, spinning, size = 40 }) {
            const blades = 8;
            return (
                <g transform={`translate(${x},${y})`} className={spinning ? 'turbine-spinning' : 'turbine-idle'}>
                    <circle cx={0} cy={0} r={size + 6} fill="none"
                        stroke={spinning ? 'var(--accent-yellow)' : 'var(--text-tertiary)'}
                        strokeWidth={1} opacity={spinning ? 0.5 : 0.2} style={{ transition: 'all 0.5s' }} />
                    <g className="turbine-blade-group">
                        {Array.from({ length: blades }).map((_, i) => {
                            const angle = (360 / blades) * i;
                            return (
                                <g key={i} transform={`rotate(${angle})`}>
                                    <path d={`M-2,${-size + 4} Q0,${-size/2} 3,${-6} L-3,${-6} Q0,${-size/2} 2,${-size + 4} Z`}
                                        fill={spinning ? 'var(--accent-yellow)' : 'var(--text-tertiary)'}
                                        opacity={spinning ? 0.8 : 0.3}
                                        style={{ transition: 'fill 0.5s, opacity 0.5s' }} />
                                </g>
                            );
                        })}
                    </g>
                    <circle cx={0} cy={0} r={9} fill={spinning ? 'var(--accent-yellow)' : 'var(--text-tertiary)'}
                        stroke={spinning ? 'var(--accent-yellow-light)' : '#aaa'} strokeWidth={1.5}
                        style={{ transition: 'all 0.5s' }} />
                    <circle cx={0} cy={0} r={4} fill="var(--bg-card)" />
                    {spinning && (
                        <text x={0} y={size + 18} textAnchor="middle" fill="var(--accent-yellow)"
                            fontSize={8} fontFamily="IBM Plex Mono" opacity={0.6}
                            style={{ animation: 'progressPulse 1.5s ease-in-out infinite' }}>
                            3000 RPM
                        </text>
                    )}
                </g>
            );
        }

        function ElectricArc({ x1, y1, x2, y2, active }) {
            if (!active) return null;
            const mid = { x: (x1 + x2) / 2, y: (y1 + y2) / 2 };
            return (
                <g>
                    {[-8, 0, 8].map((offset, idx) => (
                        <path key={idx}
                            d={`M${x1},${y1 + offset * 0.5} Q${mid.x},${mid.y + offset} ${x2},${y2 + offset * 0.5}`}
                            fill="none" stroke="var(--accent-electric)"
                            strokeWidth={idx === 1 ? 2 : 1} strokeDasharray="4,4"
                            opacity={idx === 1 ? 0.7 : 0.25}
                            style={{ animation: `flow-dash 0.4s linear infinite`, animationDelay: `${idx * 0.13}s` }} />
                    ))}
                </g>
            );
        }

        function CoolingTower({ x, y, active }) {
            return (
                <g transform={`translate(${x},${y})`}>
                    <path d="M-22,0 Q-25,-25 -15,-52 Q-10,-58 0,-60 Q10,-58 15,-52 Q25,-25 22,0 Z"
                        fill="var(--bg-elevated)" stroke={active ? 'var(--accent-water)' : 'var(--text-tertiary)'} strokeWidth={1.5}
                        style={{ transition: 'stroke 0.5s' }} />
                    <path d="M-18,-5 Q-20,-25 -12,-48 Q0,-55 12,-48 Q20,-25 18,-5 Z"
                        fill="var(--bg-card)" opacity={0.5} />
                    <ellipse cx={0} cy={2} rx={24} ry={5} fill="var(--bg-card)"
                        stroke={active ? 'var(--accent-water)' : 'var(--text-tertiary)'} strokeWidth={0.8} opacity={0.6} />
                    {active && [0, 1, 2, 3, 4].map(i => (
                        <circle key={i} cx={-6 + i * 3} cy={-60} r={3 + i % 2}
                            fill="var(--accent-steam-light)" opacity={0.4}
                            style={{ animation: `cooling-tower-steam ${2.5 + i * 0.4}s ease-out infinite`, animationDelay: `${i * 0.35}s` }} />
                    ))}
                </g>
            );
        }

        function FlowPipe({ path, active, color = 'var(--accent-steam)', width = 3, reverse = false }) {
            return (
                <g>
                    <path d={path} fill="none" stroke={color} strokeWidth={width} opacity={0.12} strokeLinecap="round" />
                    {active && (
                        <path d={path} fill="none" stroke={color} strokeWidth={width - 1}
                            strokeDasharray="8,8" opacity={0.6} strokeLinecap="round"
                            style={{ animation: `${reverse ? 'flow-dash-reverse' : 'flow-dash'} 0.7s linear infinite` }} />
                    )}
                </g>
            );
        }

        function GaugeIndicator({ x, y, value, max, label, unit, color, active }) {
            const ratio = active ? value / max : 0;
            const angle = -120 + ratio * 240;
            const r = 18;
            return (
                <g transform={`translate(${x},${y})`} opacity={active ? 1 : 0.25} style={{ transition: 'opacity 0.5s' }}>
                    <path d={`M${-r * Math.cos(-120 * Math.PI/180)},${-r * Math.sin(-120 * Math.PI/180)} A${r},${r} 0 1,1 ${r * Math.cos(-120 * Math.PI/180)},${-r * Math.sin(-120 * Math.PI/180)}`}
                        fill="none" stroke="var(--border)" strokeWidth={3} strokeLinecap="round" />
                    {active && ratio > 0 && (
                        <path d={describeArc(0, 0, r, -210, -210 + ratio * 240)}
                            fill="none" stroke={color} strokeWidth={3} strokeLinecap="round"
                            style={{ transition: 'all 0.5s' }} />
                    )}
                    <line x1={0} y1={0}
                        x2={14 * Math.cos((angle - 90) * Math.PI / 180)}
                        y2={14 * Math.sin((angle - 90) * Math.PI / 180)}
                        stroke={active ? color : 'var(--text-tertiary)'} strokeWidth={1.5} strokeLinecap="round"
                        style={{ transition: 'all 0.5s' }} />
                    <circle cx={0} cy={0} r={2.5} fill={active ? color : 'var(--text-tertiary)'} />
                    <text x={0} y={12} textAnchor="middle" fill={active ? color : 'var(--text-tertiary)'}
                        fontSize={7} fontFamily="IBM Plex Mono" fontWeight={500} style={{ transition: 'fill 0.5s' }}>
                        {active ? `${value}${unit}` : '--'}
                    </text>
                    <text x={0} y={22} textAnchor="middle" fill="var(--text-tertiary)" fontSize={6}>{label}</text>
                </g>
            );
        }

        function describeArc(cx, cy, r, startAngle, endAngle) {
            const start = polarToCartesian(cx, cy, r, endAngle);
            const end = polarToCartesian(cx, cy, r, startAngle);
            const largeArc = endAngle - startAngle <= 180 ? "0" : "1";
            return `M ${start.x} ${start.y} A ${r} ${r} 0 ${largeArc} 0 ${end.x} ${end.y}`;
        }

        function polarToCartesian(cx, cy, r, angleDeg) {
            const rad = (angleDeg - 90) * Math.PI / 180;
            return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
        }

        // ─── Main Diagram ───────────────────────────────

        function PowerPlantDiagram({ activePhase, isRunning }) {
            const phaseIdx = PHASES.findIndex(p => p.id === activePhase);
            const isPhaseActive = (id) => {
                if (!isRunning) return false;
                return PHASES.findIndex(p => p.id === id) <= phaseIdx;
            };

            return (
                <svg viewBox="0 0 960 440" style={{ width: '100%', height: 'auto', display: 'block' }}>
                    <defs>
                        <radialGradient id="fireGlow">
                            <stop offset="0%" stopColor="#b05a2a" stopOpacity="0.15" />
                            <stop offset="100%" stopColor="#b05a2a" stopOpacity="0" />
                        </radialGradient>
                        <radialGradient id="elecGlow">
                            <stop offset="0%" stopColor="#4a4a68" stopOpacity="0.15" />
                            <stop offset="100%" stopColor="#4a4a68" stopOpacity="0" />
                        </radialGradient>
                        <radialGradient id="yellowGlow">
                            <stop offset="0%" stopColor="#7a6a2a" stopOpacity="0.12" />
                            <stop offset="100%" stopColor="#7a6a2a" stopOpacity="0" />
                        </radialGradient>
                        <radialGradient id="greenGlow">
                            <stop offset="0%" stopColor="#4a6a5a" stopOpacity="0.12" />
                            <stop offset="100%" stopColor="#4a6a5a" stopOpacity="0" />
                        </radialGradient>
                    </defs>

                    {/* Background */}
                    <rect width="960" height="440" fill="var(--bg-elevated)" rx={0} />
                    <line x1={0} y1={0} x2={960} y2={0} stroke="var(--text-primary)" strokeWidth={1} />

                    {/* Title */}
                    <text x={480} y={30} textAnchor="middle" fill="var(--text-secondary)" fontSize={12}
                        fontWeight={400} letterSpacing={3}>
                        CICLO TERMODINAMICO DI RANKINE
                    </text>

                    {/* ── BOILER / FURNACE ── */}
                    {isPhaseActive('fuel') && <circle cx={115} cy={195} r={70} fill="url(#fireGlow)" />}

                    <rect x={50} y={95} width={130} height={160} rx={0} fill="transparent"
                        stroke={isPhaseActive('fuel') ? 'var(--accent-fire)' : 'var(--text-tertiary)'}
                        strokeWidth={isPhaseActive('fuel') ? 2 : 1} opacity={isPhaseActive('fuel') ? 1 : 0.4}
                        style={{ transition: 'all 0.4s' }} />
                    <rect x={60} y={105} width={110} height={70} rx={0} fill="none"
                        stroke={isPhaseActive('boiler') ? 'var(--accent-steam)' : 'var(--text-tertiary)'}
                        strokeWidth={0.8} strokeDasharray="3,3" opacity={0.3} />

                    <text x={115} y={82} textAnchor="middle"
                        fill={isPhaseActive('fuel') ? 'var(--accent-fire)' : 'var(--text-tertiary)'}
                        fontSize={11} fontWeight={500} letterSpacing={1} style={{ transition: 'fill 0.4s' }}>CALDAIA</text>

                    {[125, 145, 165].map((y, i) => (
                        <g key={y}>
                            <line x1={65} y1={y} x2={165} y2={y}
                                stroke={isPhaseActive('boiler') ? 'var(--accent-steam)' : 'var(--text-tertiary)'}
                                strokeWidth={2} strokeLinecap="round" opacity={isPhaseActive('boiler') ? 0.7 : 0.2}
                                style={{ transition: 'all 0.4s' }} />
                            {isPhaseActive('boiler') && (
                                <line x1={65} y1={y} x2={165} y2={y}
                                    stroke="var(--accent-steam)" strokeWidth={1}
                                    strokeDasharray="3,6" opacity={0.4}
                                    style={{ animation: `flow-dash 1s linear infinite`, animationDelay: `${i * 0.2}s` }} />
                            )}
                        </g>
                    ))}

                    <Flame x={115} y={220} active={isPhaseActive('fuel')} scale={1.3} />
                    <SteamParticles x={115} y={98} active={isPhaseActive('boiler')} count={8} />

                    {isPhaseActive('fuel') && (
                        <text x={115} y={268} textAnchor="middle" fill="var(--accent-fire)" fontSize={7}
                            fontFamily="IBM Plex Mono" opacity={0.7}>
                            E.Chimica {'\u2192'} E.Termica
                        </text>
                    )}

                    {/* ── STEAM PIPE ── */}
                    <FlowPipe path="M180,155 C220,155 240,175 280,175" active={isPhaseActive('turbine')} color="var(--accent-steam)" width={4} />
                    {isPhaseActive('turbine') && (
                        <text x={230} y={148} textAnchor="middle" fill="var(--accent-steam)"
                            fontSize={7} fontFamily="IBM Plex Mono" opacity={0.5}>250 bar</text>
                    )}

                    {/* ── TURBINE ── */}
                    {isPhaseActive('turbine') && <circle cx={345} cy={180} r={55} fill="url(#yellowGlow)" />}

                    <rect x={275} y={115} width={140} height={130} rx={0} fill="transparent"
                        stroke={isPhaseActive('turbine') ? 'var(--accent-yellow)' : 'var(--text-tertiary)'}
                        strokeWidth={isPhaseActive('turbine') ? 2 : 1} opacity={isPhaseActive('turbine') ? 1 : 0.4}
                        style={{ transition: 'all 0.4s' }} />

                    <text x={345} y={102} textAnchor="middle"
                        fill={isPhaseActive('turbine') ? 'var(--accent-yellow)' : 'var(--text-tertiary)'}
                        fontSize={11} fontWeight={500} letterSpacing={1} style={{ transition: 'fill 0.4s' }}>TURBINA</text>

                    {isPhaseActive('turbine') && (
                        <g opacity={0.5}>
                            <text x={300} y={130} fill="var(--accent-yellow)" fontSize={6} fontFamily="IBM Plex Mono">AP</text>
                            <text x={335} y={130} fill="var(--accent-yellow)" fontSize={6} fontFamily="IBM Plex Mono">MP</text>
                            <text x={370} y={130} fill="var(--accent-yellow)" fontSize={6} fontFamily="IBM Plex Mono">BP</text>
                        </g>
                    )}

                    <TurbineIcon x={345} y={180} spinning={isPhaseActive('turbine')} size={38} />

                    {isPhaseActive('turbine') && (
                        <text x={345} y={258} textAnchor="middle" fill="var(--accent-yellow)" fontSize={7}
                            fontFamily="IBM Plex Mono" opacity={0.7}>
                            E.Termica {'\u2192'} E.Meccanica
                        </text>
                    )}

                    {/* ── SHAFT ── */}
                    <FlowPipe path="M415,180 L475,180" active={isPhaseActive('generator')} color="var(--accent-yellow)" width={4} />

                    {/* ── GENERATOR ── */}
                    {isPhaseActive('generator') && <circle cx={530} cy={180} r={50} fill="url(#elecGlow)" />}

                    <rect x={470} y={125} width={120} height={110} rx={0} fill="transparent"
                        stroke={isPhaseActive('generator') ? 'var(--accent-electric)' : 'var(--text-tertiary)'}
                        strokeWidth={isPhaseActive('generator') ? 2 : 1} opacity={isPhaseActive('generator') ? 1 : 0.4}
                        style={{ transition: 'all 0.4s' }} />

                    <text x={530} y={112} textAnchor="middle"
                        fill={isPhaseActive('generator') ? 'var(--accent-electric)' : 'var(--text-tertiary)'}
                        fontSize={11} fontWeight={500} letterSpacing={1} style={{ transition: 'fill 0.4s' }}>ALTERNATORE</text>

                    <circle cx={530} cy={178} r={32} fill="none"
                        stroke={isPhaseActive('generator') ? 'var(--accent-electric)' : 'var(--text-tertiary)'}
                        strokeWidth={2} opacity={isPhaseActive('generator') ? 0.8 : 0.3}
                        style={{ transition: 'all 0.4s' }} />

                    {isPhaseActive('generator') && (
                        <g>
                            {[0, 60, 120, 180, 240, 300].map((angle, i) => {
                                const rad = angle * Math.PI / 180;
                                return (
                                    <circle key={i} cx={530 + 24 * Math.cos(rad)} cy={178 + 24 * Math.sin(rad)}
                                        r={3} fill="none" stroke="var(--accent-electric)" strokeWidth={1.5}
                                        style={{ animation: `rotor-coil-pulse 0.8s ease-in-out infinite`, animationDelay: `${i * 0.13}s` }} />
                                );
                            })}
                        </g>
                    )}

                    <text x={530} y={183} textAnchor="middle"
                        fill={isPhaseActive('generator') ? 'var(--accent-electric)' : 'var(--text-tertiary)'}
                        fontSize={18} fontWeight={600} fontFamily="IBM Plex Mono"
                        style={{ transition: 'fill 0.4s' }}>G</text>

                    <ElectricArc x1={562} y1={178} x2={655} y2={178} active={isPhaseActive('generator')} />

                    {isPhaseActive('generator') && (
                        <text x={530} y={243} textAnchor="middle" fill="var(--accent-electric)" fontSize={7}
                            fontFamily="IBM Plex Mono" opacity={0.7}>
                            E.Meccanica {'\u2192'} E.Elettrica
                        </text>
                    )}

                    <GaugeIndicator x={575} y={218} value={50} max={60}
                        label="Freq" unit="Hz" color="var(--accent-electric)" active={isPhaseActive('generator')} />

                    {/* ── TRANSFORMER ── */}
                    {isPhaseActive('transformer') && <circle cx={720} cy={178} r={45} fill="url(#greenGlow)" />}

                    <rect x={655} y={125} width={130} height={110} rx={0} fill="transparent"
                        stroke={isPhaseActive('transformer') ? 'var(--accent-green)' : 'var(--text-tertiary)'}
                        strokeWidth={isPhaseActive('transformer') ? 2 : 1} opacity={isPhaseActive('transformer') ? 1 : 0.4}
                        style={{ transition: 'all 0.4s' }} />

                    <text x={720} y={112} textAnchor="middle"
                        fill={isPhaseActive('transformer') ? 'var(--accent-green)' : 'var(--text-tertiary)'}
                        fontSize={10} fontWeight={500} letterSpacing={1} style={{ transition: 'fill 0.4s' }}>TRASFORMATORE</text>

                    <circle cx={698} cy={176} r={22} fill="none"
                        stroke={isPhaseActive('transformer') ? 'var(--accent-electric)' : 'var(--text-tertiary)'}
                        strokeWidth={2} opacity={isPhaseActive('transformer') ? 0.7 : 0.3} style={{ transition: 'all 0.4s' }} />
                    <circle cx={742} cy={176} r={22} fill="none"
                        stroke={isPhaseActive('transformer') ? 'var(--accent-green)' : 'var(--text-tertiary)'}
                        strokeWidth={2} opacity={isPhaseActive('transformer') ? 0.7 : 0.3} style={{ transition: 'all 0.4s' }} />
                    <rect x={713} y={158} width={14} height={36} rx={2}
                        fill={isPhaseActive('transformer') ? 'var(--bg-card)' : 'var(--bg-elevated)'}
                        stroke={isPhaseActive('transformer') ? 'var(--accent-green)' : 'var(--text-tertiary)'}
                        strokeWidth={1} opacity={0.6} style={{ transition: 'all 0.4s' }} />

                    <text x={698} y={180} textAnchor="middle"
                        fill={isPhaseActive('transformer') ? 'var(--accent-electric)' : 'var(--text-tertiary)'}
                        fontSize={8} fontFamily="IBM Plex Mono" fontWeight={500}>20kV</text>
                    <text x={742} y={180} textAnchor="middle"
                        fill={isPhaseActive('transformer') ? 'var(--accent-green)' : 'var(--text-tertiary)'}
                        fontSize={8} fontFamily="IBM Plex Mono" fontWeight={500}>380kV</text>

                    {isPhaseActive('transformer') && (
                        <text x={720} y={220} textAnchor="middle" fill="var(--accent-green)" fontSize={7}
                            fontFamily="IBM Plex Mono" opacity={0.6}>
                            {'\u03b7'} = 99.5%
                        </text>
                    )}

                    {/* ── TRANSMISSION ── */}
                    <FlowPipe path="M785,178 L840,178" active={isPhaseActive('transformer')} color="var(--accent-green)" width={3} />

                    <g transform="translate(880,105)" opacity={isPhaseActive('transformer') ? 1 : 0.25}
                        style={{ transition: 'opacity 0.4s' }}>
                        <line x1={0} y1={0} x2={0} y2={100} stroke="var(--accent-green)" strokeWidth={2} />
                        <line x1={-28} y1={10} x2={28} y2={10} stroke="var(--accent-green)" strokeWidth={1.5} />
                        <line x1={-22} y1={30} x2={22} y2={30} stroke="var(--accent-green)" strokeWidth={1.5} />
                        <line x1={-16} y1={50} x2={16} y2={50} stroke="var(--accent-green)" strokeWidth={1.5} />
                        <line x1={-14} y1={100} x2={14} y2={100} stroke="var(--accent-green)" strokeWidth={2} />
                        {[-28, 0, 28].map((ox, i) => (
                            <circle key={i} cx={ox} cy={10} r={3}
                                fill={isPhaseActive('transformer') ? 'var(--accent-green)' : 'var(--text-tertiary)'}
                                style={{ transition: 'fill 0.4s', animation: isPhaseActive('transformer') ? 'electric-pulse 1.5s ease-in-out infinite' : 'none', animationDelay: `${i * 0.2}s` }} />
                        ))}
                        <text x={0} y={115} textAnchor="middle"
                            fill={isPhaseActive('transformer') ? 'var(--accent-green)' : 'var(--text-tertiary)'}
                            fontSize={8} fontWeight={500} style={{ transition: 'fill 0.4s' }}>RETE</text>
                    </g>

                    {/* ── COOLING CYCLE ── */}
                    <FlowPipe path="M345,245 L345,330 L240,330" active={isPhaseActive('cooling')} color="var(--accent-water)" width={3} />

                    <rect x={95} y={300} width={145} height={55} rx={0} fill="transparent"
                        stroke={isPhaseActive('cooling') ? 'var(--accent-water)' : 'var(--text-tertiary)'}
                        strokeWidth={isPhaseActive('cooling') ? 2 : 1} opacity={isPhaseActive('cooling') ? 1 : 0.4}
                        style={{ transition: 'all 0.4s' }} />

                    <text x={167} y={290} textAnchor="middle"
                        fill={isPhaseActive('cooling') ? 'var(--accent-water)' : 'var(--text-tertiary)'}
                        fontSize={10} fontWeight={500} letterSpacing={1} style={{ transition: 'fill 0.4s' }}>CONDENSATORE</text>

                    {isPhaseActive('cooling') && (
                        <g opacity={0.5}>
                            <path d="M110,325 Q120,318 130,325 Q140,332 150,325 Q160,318 170,325 Q180,332 190,325 Q200,318 210,325 Q220,332 225,325"
                                fill="none" stroke="var(--accent-water)" strokeWidth={1.5} />
                        </g>
                    )}

                    <FlowPipe path="M105,300 L105,270 L75,270 L75,255" active={isPhaseActive('cooling')} color="var(--accent-water)" width={2.5} reverse={true} />

                    {isPhaseActive('cooling') && (
                        <text x={66} y={280} fill="var(--accent-water)" fontSize={7}
                            fontFamily="IBM Plex Mono" opacity={0.6}>H{'\u2082'}O</text>
                    )}

                    <FlowPipe path="M240,340 L500,340" active={isPhaseActive('cooling')} color="var(--accent-water)" width={2.5} />

                    <CoolingTower x={540} y={360} active={isPhaseActive('cooling')} />
                    <CoolingTower x={600} y={360} active={isPhaseActive('cooling')} />

                    <text x={570} y={390} textAnchor="middle"
                        fill={isPhaseActive('cooling') ? 'var(--accent-water)' : 'var(--text-tertiary)'}
                        fontSize={8} fontWeight={500} letterSpacing={0.5} style={{ transition: 'fill 0.4s' }}>TORRI EVAPORATIVE</text>

                    <GaugeIndicator x={167} y={370} value={35} max={100}
                        label="Temp" unit={'\u00b0C'} color="var(--accent-water)" active={isPhaseActive('cooling')} />

                    {/* Efficiency box */}
                    {isRunning && (
                        <g style={{ animation: 'fadeIn 0.4s ease' }}>
                            <rect x={700} y={310} width={140} height={70} rx={0} fill="transparent"
                                stroke="var(--text-tertiary)" strokeWidth={1} opacity={0.5} />
                            <text x={770} y={332} textAnchor="middle" fill="var(--text-tertiary)" fontSize={8}
                                fontWeight={500} letterSpacing={1}>RENDIMENTO CICLO</text>
                            <text x={770} y={358} textAnchor="middle" fill="var(--accent-green)" fontSize={22}
                                fontWeight={600} fontFamily="IBM Plex Mono">
                                {isPhaseActive('cooling') ? '42' : Math.round(20 + phaseIdx * 4)}%
                            </text>
                            <text x={770} y={372} textAnchor="middle" fill="var(--text-tertiary)" fontSize={7}
                                fontFamily="IBM Plex Mono">Carnot limit: ~63%</text>
                        </g>
                    )}
                </svg>
            );
        }

        // ─── Info Card (Dashboard style) ────────────────

        function PhaseCard({ phase, isActive, onClick }) {
            return (
                <div onClick={onClick} style={{
                    background: 'transparent',
                    borderLeft: `3px solid ${isActive ? phase.color : 'transparent'}`,
                    borderTop: 'none', borderRight: 'none', borderBottom: 'none',
                    borderRadius: 0,
                    padding: '1.2rem 0 1.2rem 1.2rem',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease',
                    opacity: isActive ? 1 : 0.5,
                }}>
                    <div style={{ display: 'flex', alignItems: 'baseline', gap: 10, marginBottom: isActive ? 10 : 0 }}>
                        <div style={{ flex: 1 }}>
                            <div style={{
                                fontSize: 14, fontWeight: 500,
                                color: isActive ? 'var(--text-primary)' : 'var(--text-secondary)',
                                transition: 'color 0.3s', letterSpacing: '-0.01em',
                            }}>
                                {phase.title}
                            </div>
                            <div style={{ fontSize: 11, color: 'var(--text-tertiary)', marginTop: 2 }}>
                                {phase.subtitle}
                            </div>
                        </div>
                    </div>
                    {isActive && (
                        <div style={{ animation: 'fadeInSlide 0.3s ease' }}>
                            <p style={{
                                fontSize: 12.5, lineHeight: 1.75,
                                color: 'var(--text-secondary)', margin: '0 0 12px 0',
                            }}>
                                {phase.description}
                            </p>
                            <div style={{ display: 'flex', gap: 16, flexWrap: 'wrap' }}>
                                {phase.details.map((detail, i) => (
                                    <div key={i} style={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                                        <div style={{ fontSize: 9, color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: '0.05em', fontWeight: 500 }}>
                                            {detail.label}
                                        </div>
                                        <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--text-primary)', fontFamily: 'IBM Plex Mono' }}>
                                            {detail.value}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ─── Stats Bar ──────────────────────────────────

        function StatsBar({ activePhase, isRunning }) {
            const phaseIdx = PHASES.findIndex(p => p.id === activePhase);
            const efficiency = isRunning ? Math.min(36 + phaseIdx * 2, 42) : 0;
            const output = isRunning ? Math.round((phaseIdx + 1) / PHASES.length * 1200) : 0;
            const frequency = isRunning && phaseIdx >= 3 ? 50 : 0;
            const voltage = isRunning && phaseIdx >= 4 ? 380 : (isRunning && phaseIdx >= 3 ? 20 : 0);

            const stats = [
                { label: 'Potenza', value: `${output} MW`, active: isRunning },
                { label: 'Rendimento', value: `${efficiency}%`, active: isRunning },
                { label: 'Frequenza', value: frequency ? `${frequency} Hz` : '\u2014', active: frequency > 0 },
                { label: 'Tensione', value: voltage ? `${voltage} kV` : '\u2014', active: voltage > 0 },
                { label: 'Fase', value: `${phaseIdx + 1}/${PHASES.length}`, active: true },
                { label: 'Stato', value: isRunning ? 'ATTIVO' : 'FERMO', active: true },
            ];

            return (
                <div style={{ display: 'flex', gap: '3rem', marginBottom: 20, flexWrap: 'wrap' }}>
                    {stats.map((stat, i) => (
                        <div key={i} style={{ display: 'flex', flexDirection: 'column', gap: '0.3rem' }}>
                            <span style={{
                                fontSize: '0.75rem', letterSpacing: '0.05em',
                                color: 'var(--text-secondary)', textTransform: 'uppercase', fontWeight: 500,
                            }}>{stat.label}</span>
                            <span style={{
                                fontFamily: 'IBM Plex Mono', fontSize: '1.5rem', fontWeight: 500,
                                color: stat.active ? 'var(--text-primary)' : 'var(--text-tertiary)',
                                transition: 'color 0.3s',
                            }}>{stat.value}</span>
                        </div>
                    ))}
                </div>
            );
        }

        // ─── Progress Bar ───────────────────────────────

        function ProgressBar({ activePhase, isRunning }) {
            const phaseIdx = PHASES.findIndex(p => p.id === activePhase);
            return (
                <div style={{ display: 'flex', gap: 3, marginBottom: 20 }}>
                    {PHASES.map((phase, i) => (
                        <div key={i} style={{
                            flex: 1, height: 4,
                            background: isRunning && i <= phaseIdx ? 'var(--accent-bar)' : 'var(--border)',
                            transition: 'background 0.4s ease',
                        }} />
                    ))}
                </div>
            );
        }

        // ─── Energy Flow ────────────────────────────────

        function EnergyFlowBar({ isRunning, activePhase }) {
            if (!isRunning) return null;
            const phaseIdx = PHASES.findIndex(p => p.id === activePhase);
            const stages = [
                { label: 'Chimica', active: phaseIdx >= 0 },
                { label: 'Termica', active: phaseIdx >= 1 },
                { label: 'Meccanica', active: phaseIdx >= 2 },
                { label: 'Elettrica', active: phaseIdx >= 3 },
                { label: 'Alta Tensione', active: phaseIdx >= 4 },
            ];
            return (
                <div style={{
                    display: 'flex', alignItems: 'center', gap: 6, marginBottom: 20,
                    borderTop: '1px solid var(--text-primary)', paddingTop: 12,
                    animation: 'fadeIn 0.4s ease',
                }}>
                    <span style={{ fontSize: 10, color: 'var(--text-tertiary)', marginRight: 8, fontWeight: 500, letterSpacing: '0.05em', textTransform: 'uppercase' }}>
                        Flusso:
                    </span>
                    {stages.map((stage, i) => (
                        <React.Fragment key={i}>
                            <span style={{
                                fontSize: 11, fontWeight: 500,
                                color: stage.active ? 'var(--text-primary)' : 'var(--text-tertiary)',
                                opacity: stage.active ? 1 : 0.4, transition: 'all 0.4s',
                                fontFamily: 'IBM Plex Mono',
                            }}>{stage.label}</span>
                            {i < stages.length - 1 && (
                                <span style={{
                                    color: stage.active && stages[i+1].active ? 'var(--text-secondary)' : 'var(--text-tertiary)',
                                    opacity: stage.active && stages[i+1].active ? 0.7 : 0.2,
                                    fontSize: 12, transition: 'all 0.4s',
                                }}>{'\u2192'}</span>
                            )}
                        </React.Fragment>
                    ))}
                </div>
            );
        }

        // ─── Main App ───────────────────────────────────

        function App() {
            const [activePhase, setActivePhase] = useState('fuel');
            const [isRunning, setIsRunning] = useState(false);
            const [autoPlay, setAutoPlay] = useState(false);
            const intervalRef = useRef(null);

            const nextPhase = useCallback(() => {
                setActivePhase(prev => {
                    const idx = PHASES.findIndex(p => p.id === prev);
                    return PHASES[(idx + 1) % PHASES.length].id;
                });
            }, []);

            const prevPhase = useCallback(() => {
                setActivePhase(prev => {
                    const idx = PHASES.findIndex(p => p.id === prev);
                    return PHASES[(idx - 1 + PHASES.length) % PHASES.length].id;
                });
            }, []);

            useEffect(() => {
                if (autoPlay && isRunning) {
                    intervalRef.current = setInterval(nextPhase, 3500);
                    return () => clearInterval(intervalRef.current);
                }
                if (intervalRef.current) clearInterval(intervalRef.current);
            }, [autoPlay, isRunning, nextPhase]);

            useEffect(() => {
                const handler = (e) => {
                    if (e.key === 'ArrowRight') nextPhase();
                    if (e.key === 'ArrowLeft') prevPhase();
                    if (e.key === ' ') { e.preventDefault(); setIsRunning(r => !r); }
                    if (e.key === 'a' || e.key === 'A') setAutoPlay(a => !a);
                };
                window.addEventListener('keydown', handler);
                return () => window.removeEventListener('keydown', handler);
            }, [nextPhase, prevPhase]);

            const handleStart = () => {
                setIsRunning(r => {
                    if (!r) { setActivePhase('fuel'); setAutoPlay(false); }
                    return !r;
                });
            };

            const btnStyle = {
                border: 'none', borderRadius: 0, padding: '10px 24px',
                fontSize: 13, fontWeight: 500, cursor: 'pointer',
                fontFamily: 'Archivo', transition: 'all 0.2s',
                letterSpacing: '0.02em', outline: 'none',
                background: 'transparent', color: 'var(--text-primary)',
                borderBottom: '2px solid var(--text-tertiary)',
            };

            return (
                <div style={{ maxWidth: 1600, margin: '0 auto', padding: '3rem 4rem',
                    animation: 'fadeInSlide 1.2s cubic-bezier(0.16, 1, 0.3, 1)' }}>

                    {/* Header - matching dashboard style */}
                    <header style={{ marginBottom: '2rem' }}>
                        <h1 style={{
                            fontSize: '2.5rem', fontWeight: 400, letterSpacing: '-0.02em',
                            color: 'var(--text-primary)', marginBottom: '1rem', lineHeight: 1.1,
                            paddingLeft: 20, position: 'relative',
                        }}>
                            <span style={{
                                position: 'absolute', left: 0, top: 0, width: 4, height: 60,
                                background: 'var(--text-primary)',
                            }} />
                            Centrale Elettrica
                        </h1>
                        <p style={{
                            color: 'var(--text-secondary)', fontSize: 14, maxWidth: 600, lineHeight: 1.6,
                            paddingLeft: 20,
                        }}>
                            Animazione interattiva del ciclo termodinamico di Rankine.
                            Premi <strong>AVVIA</strong> per esplorare ogni fase del processo.
                        </p>
                    </header>

                    <StatsBar activePhase={activePhase} isRunning={isRunning} />
                    <ProgressBar activePhase={activePhase} isRunning={isRunning} />
                    <EnergyFlowBar isRunning={isRunning} activePhase={activePhase} />

                    {/* Diagram */}
                    <div style={{
                        borderTop: '1px solid var(--text-primary)', padding: '1.5rem 0',
                        marginBottom: 24,
                    }}>
                        <PowerPlantDiagram activePhase={activePhase} isRunning={isRunning} />
                    </div>

                    {/* Controls */}
                    <div style={{ display: 'flex', gap: 12, marginBottom: 28, flexWrap: 'wrap' }}>
                        <button onClick={prevPhase} style={btnStyle}>
                            {'\u2190'} Precedente
                        </button>
                        <button onClick={handleStart} style={{
                            ...btnStyle,
                            borderBottom: `2px solid ${isRunning ? 'var(--accent-red)' : 'var(--accent-green)'}`,
                            fontWeight: 600,
                        }}>
                            {isRunning ? '\u25a0  FERMA' : '\u25b6  AVVIA'}
                        </button>
                        <button onClick={nextPhase} style={btnStyle}>
                            Successiva {'\u2192'}
                        </button>
                        <button onClick={() => setAutoPlay(a => !a)} style={{
                            ...btnStyle,
                            borderBottom: `2px solid ${autoPlay ? 'var(--accent-bar)' : 'var(--text-tertiary)'}`,
                        }}>
                            {autoPlay ? '\u23f8 Auto' : '\u25b6 Auto'}
                        </button>
                    </div>

                    {/* Phase Cards */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
                        gap: 0,
                        borderTop: '1px solid var(--text-primary)',
                    }}>
                        {PHASES.map(phase => (
                            <PhaseCard key={phase.id} phase={phase}
                                isActive={activePhase === phase.id}
                                onClick={() => setActivePhase(phase.id)} />
                        ))}
                    </div>

                    {/* Shortcuts */}
                    <div style={{
                        marginTop: 28, color: 'var(--text-tertiary)', fontSize: 11,
                        display: 'flex', gap: 20, flexWrap: 'wrap',
                    }}>
                        {[
                            { key: '\u2190 \u2192', desc: 'Cambia fase' },
                            { key: 'Spazio', desc: 'Avvia/Ferma' },
                            { key: 'A', desc: 'Auto-play' },
                        ].map((s, i) => (
                            <span key={i}><strong>{s.key}</strong> {s.desc}</span>
                        ))}
                    </div>

                    {/* Back link */}
                    <div style={{ marginTop: 20 }}>
                        <a href="index.html" style={{
                            color: 'var(--text-secondary)', textDecoration: 'none',
                            fontSize: 12, borderBottom: '1px solid var(--text-tertiary)',
                            paddingBottom: 2,
                        }}>
                            {'\u2190'} Torna alla Dashboard SmartGrid
                        </a>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
